items = [["400102836", "400103162", "keep only children of 400102836"], [nil, "400107124", nil], ["400102842", "400103165", "keep only children of 400102842"], [nil, "400107127", nil], [nil, "400110219", nil], ["400103109", "400102198", "keep only children of 400103109"], [nil, "400107162", nil], ["400103118", "400102202", "keep only children of 400103118"], [nil, "400107185", nil], ["400103143", "400102215", "keep only children of 400103143"], [nil, "400107178", nil], ["400103157", "400102803", "keep only children of 400103157"], [nil, "400103100", nil], [nil, "400103150", nil], [nil, "400110222", nil], ["400107166", "400102222", "keep only children of 400107166"], [nil, "400103127", nil], ["400108721", "400103313", "keep only children of 400108721"], [nil, "400109017", nil], ["402008317", "406003677", "keep only children of 402008317"], [nil, "408000659", nil], ["402008355", "406003249", "keep only children of 402008355"], [nil, "408001039", nil], ["402008384", "402006447", nil], [nil, "408000590", "s"], [nil, "410007030", nil], ["406003674", "402008314", "keep only children of 406003674"], [nil, "408000656", nil], ["407000409", "407000416", "keep only children of 407000409"], [nil, "407000423", nil], ["407000430", "407000444", "keep only children of 407000430"], [nil, "407000458", nil], ["408000896", "402007683", "keep only children of 408000896"], [nil, "406003230", nil], ["410002451", "401001194", "keep only children of 410002451"], [nil, "410002447", nil], [nil, "410002450", nil], [nil, "410002452", nil], ["410006933", "402007812", "keep only children of 410006933"], [nil, "408000790", nil], ["990015306", "402007222", nil], [nil, "402013036", nil], [nil, "406003199", "s"], ["990015307", "402007301", nil], [nil, "402013043", nil], [nil, "406003560", "s"], ["990015308", "402007243", "s"], [nil, "406003371", nil], ["990015309", "402007272", "s"], [nil, "406003526", nil], [nil, "408000871", nil], [nil, "410007052", nil], ["990015310", "402008111", "s"], [nil, "406003222", nil], ["990015311", "402007802", nil], [nil, "406003567", "s"], [nil, "408000835", nil], [nil, "410006939", nil], ["990015314", "402007236", nil], [nil, "406003614", "s"], [nil, "408000852", nil], ["990015315", "402007781", nil], [nil, "406003317", "s"], [nil, "410007034", nil], ["990015316", "402007229", nil], [nil, "406003400", nil], [nil, "408000860", "s"], ["990015318", "402008270", nil], [nil, "408000922", "s"], ["990015320", "402007795", nil], [nil, "408001159", "s"], ["990015322", "402007308", nil], [nil, "406003665", "s"], ["990017055", "402007974", nil], [nil, "406003444", "s"], ["990017401", "402008086", nil], [nil, "406003122", "s"], [nil, "408000764", nil], ["990018254", "406003712", "s"], [nil, "408000559", nil], ["990021724", "402007315", nil], [nil, "402013151", nil], [nil, "406003578", "s"], [nil, "410006977", nil], ["990021725", "402007788", nil], [nil, "402013158", "s"], ["990023506", "402008469", nil], [nil, "406003638", "s"], [nil, "408001219", nil], ["990023606", "402007658", nil], [nil, "406003585", "s"], [nil, "408000809", nil], [nil, "410006987", nil], ["990023609", "406003187", "s"], [nil, "408000845", nil], ["990023618", "402008118", "s"], [nil, "406003738", nil], ["990025975", "402007713", nil], [nil, "408001289", "s"], ["990026236", "402007818", "s"], [nil, "406003291", nil], ["990033054", "402007927", "s"], [nil, "402013449", nil], ["990033056", "402008371", "s"], [nil, "408001093", nil], ["990033058", "402008070", "s"], [nil, "402013490", nil], ["990033819", "400014945", nil], [nil, "408001319", "s"], ["990033839", "402008012", "s"], [nil, "402013711", nil], ["990033840", "402007525", nil], [nil, "402013704", "s"], ["990033841", "402007488", nil], [nil, "408000936", "s"], ["990034717", "402013841", "s"], [nil, "406003266", nil], ["990036536", "402008484", "s"], [nil, "406003610", nil], [nil, "410007041", nil], ["990036538", "402006353", nil], [nil, "402008263", nil], [nil, "406003658", "s"], ["990037133", "402008025", nil], [nil, "406003719", nil], [nil, "408001262", "s"], ["990037135", "402007532", nil], [nil, "406003726", nil], [nil, "408000973", "s"], ["990037138", "402007474", nil], [nil, "406003180", "s"], ["990038874", "402007980", "s"], [nil, "406003275", nil], [nil, "408001007", nil], ["990038875", "402007996", nil], [nil, "406003450", "s"], ["990041208", "402008193", nil], [nil, "402013911", "s"], ["990041210", "402007466", nil], [nil, "402013903", "s"], ["990041211", "402008230", nil], [nil, "408001092", "s"], ["990041212", "402007722", nil], [nil, "402013928", "s"], ["990041213", "402008190", nil], [nil, "402013932", "s"], ["990048643", "402008133", nil], [nil, "406003325", "s"], ["990048645", "402007645", nil], [nil, "406003410", nil], [nil, "408000796", "s"], ["990053707", "402007544", "s"], [nil, "402014222", nil], ["990053708", "402007571", "s"], [nil, "402014249", nil], ["990053709", "402007598", nil], [nil, "402014276", "s"], ["990058547", "402007450", "UNDEF"], [nil, "408000155", nil], ["990058557", "402008177", nil], [nil, "408000172", "s"], ["990063915", "402007749", "s"], [nil, "406003169", nil], ["991014238", "402008404", nil], [nil, "406003338", nil], [nil, "408000695", "s"], ["991014241", "402008397", "s"], [nil, "410007572", nil], ["991014244", "402008496", "s"], [nil, "410007484", nil], ["991014249", "402006362", nil], [nil, "402007200", "s"], ["991014250", "402007195", "s"], [nil, "406003334", nil], ["991014251", "400056030", "UNDEF"], [nil, "406003194", nil], ["991014253", "406003355", "s"], [nil, "408000577", nil], ["991014254", "402007217", nil], [nil, "408000696", "s"]]



  module Kernel

    alias_method :"old_puts", :"puts"

    def puts(object)
      #old_puts("ciao " + object)
      #old_puts(__FILE__, ":", __LINE__, ":", object)
      caller_locations(1, 1).first.tap{|loc| old_puts "#{loc.path}:#{loc.lineno}:#{object}"}

    end
  end

def old_parent2child(parent_id, s)
    old_parents = {}
    s.child_sources.each do |cs|
        
        cs.versions.each do |v|
            if v.event.start_with?("CH Migration parent")
                t = v.event.split(" ")
                old_id = t[3]

                next if old_id != parent_id

                if !old_parents.keys.include?(old_id)
                    old_parents[old_id] = [cs] 
                else
                    old_parents[old_id] << cs
                end

            end
        end

    end

    return old_parents
end

last_id = nil
items.each do |item|
    last_id = item[0] if item[0]

    parent = Source.find(last_id)

    old_with_child = old_parent2child(item[1], parent)

    next if item[2] == "s"

    old_with_child.each do |old_id, children|

        children.each do |c| 
            parent.marc.each_by_tag("774") do |t|
                st = t.fetch_first_by_tag("w")
                t.destroy_yourself if st.content == c.id.to_s
            end
            
            c.destroy
        end
    end

    parent.save
end

