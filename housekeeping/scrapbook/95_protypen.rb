all = []

pt = {
'*A23': '00C0',
'*A22': '00C1',
'*A24': '00C2',
'*A26': '00C3',
'*A25': '00C4',
'*A29': '00C5',
'*A45': '00C6',
'*C49': '00C7',
'*E23': '00C8',
'*E22': '00C9',
'*E24': '00CA',
'*E25': '00CB',
'*I23': '00CC',
'*I22': '00CD',
'*I24': '00CE',
'*I25': '00CF',
'*D43': '00D0',
'*N26': '00D1',
'*O23': '00D2',
'*O22': '00D3',
'*O24': '00D4',
'*O26': '00D5',
'*O25': '00D6',
'*O42': '00D8',
'*U23': '00D9',
'*U22': '00DA',
'*U24': '00DB',
'*U25': '00DC',
'*Y22': '00DD',
'*S39': '00DF',
'*a23': '00E0',
'*a22': '00E1',
'*a24': '00E2',
'*a26': '00E3',
'*a25': '00E4',
'*a29': '00E5',
'*a45': '00E6',
'*c49': '00E7',
'*e23': '00E8',
'*e22': '00E9',
'*e24': '00EA',
'*e25': '00EB',
'*i23': '00EC',
'*i22': '00ED',
'*i24': '00EE',
'*i25': '00EF',
'*d44': '00F0',
'*n26': '00F1',
'*o23': '00F2',
'*o22': '00F3',
'*o24': '00F4',
'*o26': '00F5',
'*o25': '00F6',
'*561': '00F7',
'*o42': '00F8',
'*u23': '00F9',
'*u22': '00FA',
'*u24': '00FB',
'*u25': '00FC',
'*y22': '00FD',
'*p44': '00FE',
'*y25': '00FF',
'*A33': '0100',
'*a33': '0101',
'*A32': '0102',
'*a32': '0103',
'*A52': '0104',
'*a52': '0105',
'*C22': '0106',
'*c22': '0107',
'*C24': '0108',
'*c24': '0109',
'*C36': '010A',
'*c36': '010B',
'*C27': '010C',
'*c27': '010D',
'*D27': '010E',
'*d36': '010F',
'*D43': '0110',
'*E33': '0112',
'*e33': '0113',
'*E32': '0114',
'*e32': '0115',
'*E36': '0116',
'*e36': '0117',
'*E27': '011A',
'*e27': '011B',
'*G24': '011C',
'*g24': '011D',
'*G32': '011E',
'*g32': '011F',
'*g36': '0120',
'*g36': '0121',
'*G49': '0122',
'*g22': '0123',
'*H24': '0124',
'*h24': '0125',
'*I26': '0128',
'*i26': '0129',
'*I33': '012A',
'*i33': '012B',
'*I32': '012C',
'*i32': '012D',
'*J24': '0134',
'*j24': '0135',
'*L22': '0139',
'*l22': '013A',
'*L42': '0141',
'*l42': '0142',
'*N22': '0143',
'*n22': '0144',
'*N32': '0147',
'*n27': '0148',
'*O33': '014C',
'*o33': '014D',
'*O32': '014E',
'*o32': '014F',
'*O35': '0150',
'*o35': '0151',
'*O45': '0152',
'*o45': '0153',
'*R22': '0154',
'*r22': '0155',
'*R27': '0158',
'*r27': '0159',
'*S22': '015A',
'*s22': '015B',
'*S24': '015C',
'*s24': '015D',
'*S27': '0160',
'*s27': '0161',
'*T27': '0164',
'*U26': '0168',
'*u26': '0169',
'*U33': '016A',
'*u33': '016B',
'*U32': '016C',
'*u32': '016D',
'*U29': '016E',
'*u29': '016F',
'*U35': '0170',
'*u35': '0171',
'*U52': '0172',
'*u52': '0173',
'*W24': '0174',
'*w24': '0175',
'*Y24': '0176',
'*y24': '0177',
'*Y25': '0178',
'*Z22': '0179',
'*z22': '017A',
'*Z36': '017B',
'*z36': '017C',
'*Z27': '017D',
'*z27': '017E',
'*A27': '01CD',
'*a27': '01CE',
'*I27': '01CF',
'*i27': '01D0',
'*O27': '01D1',
'*o27': '01D2',
'*U27': '01D3',
'*u27': '01D4',
'*G27': '01E6',
'*g27': '01E7',
'*K27': '01E8',
'*k27': '01E9',
'*A35': '0200',
'*a35': '0201',
'*E35': '0204',
'*e35': '0205',
'*I35': '0208',
'*i35': '0209',
'*O35': '020C',
'*o35': '020D',
'*R35': '0210',
'*r35': '0211',
'*U35': '0214',
'*u35': '0215',
'*H27': '021E',
'*h27': '021F',
'*A36': '0226',
'*a36': '0227',
'*A63': '0391',
'*B63': '0392',
'*G63': '0393',
'*D63': '0394',
'*E63': '0395',
'*Z63': '0396',
'*J63': '0397',
'*H63': '0398',
'*I63': '0399',
'*K63': '039A',
'*L63': '039B',
'*M63': '039C',
'*N63': '039D',
'*Q63': '039E',
'*O63': '039F',
'*P63': '03A0',
'*R63': '03A1',
'*S63': '03A3',
'*T63': '03A4',
'*F63': '03A6',
'*X63': '03A7',
'*Y63': '03A8',
'*W63': '03A9',
'*I25': '03AA',
'*Y25': '03AB',
'*a63': '03B1',
'*b63': '03B2',
'*g63': '03B3',
'*d63': '03B4',
'*e63': '03B5',
'*z63': '03B6',
'*j63': '03B7',
'*i63': '03B9',
'*k63': '03BA',
'*l63': '03BB',
'*m63': '03BC',
'*n63': '03BD',
'*q63': '03BE',
'*o63': '03BF',
'*p63': '03C0',
'*r63': '03C1',
'*s63': '03C3',
'*t63': '03C4',
'*u63': '03C5',
'*f63': '03C6',
'*x63': '03C7',
'*y63': '03C8',
'*w63': '03C9',
'*A73': '0410',
'*G73': '0411',
'*B73': '0412',
'*F73': '0413',
'*D73': '0414',
'*E73': '0415',
'*M74': '0416',
'*Z73': '0417',
'*U73': '0418',
'*U74': '0419',
'*K73': '041A',
'*L73': '041B',
'*M73': '041C',
'*H73': '041D',
'*O73': '041E',
'*P73': '0420',
'*C73': '0421',
'*T73': '0422',
'*Y73': '0423',
'*Q74': '0424',
'*X73': '0425',
'*N73': '0426',
'*P74': '0427',
'*W73': '0429',
'*Z74': '042A',
'*X74': '042B',
'*B74': '042C',
'*J74': '042D',
'*N74': '042E',
'*R73': '042F',
'*a73': '0430',
'*g73': '0431',
'*b73': '0432',
'*f73': '0433',
'*d73': '0434',
'*e73': '0435',
'*m74': '0436',
'*j74': '0437',
'*u73': '0438',
'*u74': '0439',
'*k73': '043A',
'*i73': '043B',
'*m73': '043C',
'*h73': '043D',
'*o73': '043E',
'*n73': '043F',
'*p73': '0440',
'*c73': '0441',
'*t73': '0442',
'*y73': '0443',
'*q74': '0444',
'*x73': '0445',
'*q73': '0446',
'*p74': '0447',
'*w73': '0448',
'*w74': '0449',
'*z74': '044A',
'*x74': '044B',
'*b74': '044C',
'*j74': '044D',
'*n74': '044E',
'*r73': '044F',
'*d74': '0452',
'*c74': '0454',
'*s73': '0455',
'*i73': '0456',
'*i74': '0457',
'*j73': '0458',
'*l74': '0459',
'*h74': '045A',
'*d74': '045B',
'*k74': '045C',
'*y74': '045E',
'*v74': '045F',
'*378': '2020',
'*379': '2021',
'*362': '002A',
'*l73': '043B',
'*g74': '0463',
'*485': '266E',
}

subs = {}
pt.each do |k,v|
  subs[k] = v.hex.chr('UTF-8')
end

def find_pattern(s)
  pattern = /\b(\S*?(\*[A-Za-z0-9]\d{2})\S*)\b/
  if m = s.match(pattern)
    return [m[1], m[2]]
  else
    return nil
  end
end

#pb = ProgressBar.new(Source.all.count)
Source.find_in_batches do |batch|

  batch.each do |s|
		
    s.marc.load_source false

    s.marc.all_tags.each do |tag|

      tag.each do |subt|
        next if !subt.content
        r = find_pattern(subt.content)
        next if !r
        subbed_word = r[0].gsub(r[1], subs[r[1]]) if subs.keys.include?(r[1])
        puts "#{s.id}\t#{tag.tag}\t#{r[1]}\t#{r[0]}\t#{subbed_word}" if r
      end
    end
        
    #pb.increment!

  end

end

#puts all.sort.uniq